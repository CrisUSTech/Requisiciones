{% extends "base.html" %}
{% block content %}

<h1 class="text-xl font-semibold mb-4 text-slate-800">
    Requisición #{{ req.id }} – {{ req.proyecto }}
</h1>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div class="bg-white p-4 rounded border border-slate-200 text-sm">
        <p><b>Fecha solicitud:</b> {{ req.fecha_solicitud }}</p>
        <p><b>Fecha mantenimiento:</b> {{ req.fecha_mantenimiento }}</p>
        <p><b>Prioridad:</b> {{ req.prioridad }}</p>
        <p><b>Estado:</b> {{ req.estado }}</p>
        <p><b>Solicitante ID:</b> {{ req.solicitante_id }}</p>
        <p><b>Proveedor:</b> {{ req.proveedor or 'N/A' }}</p>
        <p><b>Costo total:</b> 
        {% if req.costo_total %}
           ${{ "%.2f"|format(req.costo_total) }}
        {% else %}
           N/A
        {% endif %}
        </p>
    </div>
    <div class="bg-white p-4 rounded border border-slate-200 text-sm">
        <p><b>Utilización:</b></p>
        <p class="mt-1 whitespace-pre-wrap">{{ req.utilizacion or 'N/A' }}</p>
        <hr class="my-2">
        <p><b>Revisado por (Almacén):</b> {{ req.revisado_por or 'N/A' }}</p>
        <p><b>Fecha revisión:</b> {{ req.fecha_revision or 'N/A' }}</p>
        <p><b>Finalizado por:</b> {{ req.finalizado_por or 'N/A' }}</p>
        <p><b>Fecha finalización:</b> {{ req.fecha_finalizacion or 'N/A' }}</p>
    </div>
</div>

<h2 class="text-sm font-semibold mb-2 text-slate-800">Materiales</h2>
<div class="overflow-x-auto bg-white rounded border border-slate-200 mb-4">
<table class="min-w-full text-xs">
    <thead class="bg-slate-100">
        <tr>
            <th class="px-2 py-1 border-b">Descripción</th>
            <th class="px-2 py-1 border-b">Unidad</th>
            <th class="px-2 py-1 border-b">Cant. Solic.</th>
            <th class="px-2 py-1 border-b">Rev. Almacén</th>
            <th class="px-2 py-1 border-b">Stock</th>
            <th class="px-2 py-1 border-b">C/U</th>
            <th class="px-2 py-1 border-b">Comprado</th>
        </tr>
    </thead>
    <tbody>
    {% for m in req.materiales %}
        <tr>
            <td class="px-2 py-1 border-b">{{ m.descripcion }}</td>
            <td class="px-2 py-1 border-b">{{ m.unidad }}</td>
            <td class="px-2 py-1 border-b">{{ m.cantidad }}</td>
            <td class="px-2 py-1 border-b">{{ m.revisado_qty }}</td>
            <td class="px-2 py-1 border-b">{{ m.stock_available }}</td>
            <td class="px-2 py-1 border-b">
                {% if m.costo_unitario %}
                    ${{ "%.2f"|format(m.costo_unitario) }}
                {% else %}
                    N/A
                {% endif %}
            </td>
            <td class="px-2 py-1 border-b">{{ m.comprado_qty }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
</div>

{% if session.get('role') == 'Almacén' %}
<!-- Formulario de ALMACÉN -->
<h3 class="text-sm font-semibold mb-2 text-slate-800">Acciones de Almacén</h3>
<form method="post" action="{{ url_for('process_almacen', req_id=req.id) }}"
      class="bg-white p-4 rounded border border-slate-200 text-xs space-y-3">
    <p class="text-slate-600">Actualiza las cantidades revisadas y stock para cada material.</p>

    <table class="min-w-full text-xs mb-3">
        <thead class="bg-slate-100">
            <tr>
                <th class="px-2 py-1 border-b">Material</th>
                <th class="px-2 py-1 border-b">Revisado</th>
                <th class="px-2 py-1 border-b">Stock</th>
            </tr>
        </thead>
        <tbody>
        {% for m in req.materiales %}
            <tr>
                <td class="px-2 py-1 border-b">{{ m.descripcion }} ({{ m.cantidad }} {{ m.unidad }})</td>
                <td class="px-2 py-1 border-b">
                    <input type="number" name="rev_{{ m.id }}" min="0" max="{{ m.cantidad }}" 
                           value="{{ m.revisado_qty }}"
                           class="w-24 border border-slate-300 rounded px-1 py-1 text-xs">
                </td>
                <td class="px-2 py-1 border-b">
                    <input type="number" name="stock_{{ m.id }}" min="0"
                           value="{{ m.stock_available }}"
                           class="w-24 border border-slate-300 rounded px-1 py-1 text-xs">
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <p class="text-xs text-slate-600 mb-1">¿Resultado de la revisión?</p>
    <div class="flex gap-3">
        <label class="inline-flex items-center text-xs">
            <input type="radio" name="accion" value="Revisado - En Stock" required class="mr-1">
            Todo en stock (Revisado - En Stock)
        </label>
        <label class="inline-flex items-center text-xs">
            <input type="radio" name="accion" value="Revisado - Autorizada" required class="mr-1">
            Faltan cosas (Autorizada para Compras)
        </label>
    </div>

    <div class="flex justify-end gap-2 pt-2">
        <button type="submit"
                class="px-3 py-2 text-xs rounded bg-blue-600 text-white hover:bg-blue-700">
            Guardar revisión de Almacén
        </button>
    </div>
</form>
{% endif %}

{% if session.get('role') == 'Compras' and req.estado in ['Revisado - Autorizada', 'Comprado (Parcial)'] %}
<!-- Formulario de COMPRAS -->
<h3 class="text-sm font-semibold mb-2 text-slate-800 mt-6">Acciones de Compras</h3>
<form method="post" action="{{ url_for('process_compras', req_id=req.id) }}"
      class="bg-white p-4 rounded border border-slate-200 text-xs space-y-3">
    <div>
        <label class="block text-xs font-medium text-slate-700 mb-1">Proveedor</label>
        <input type="text" name="proveedor" value="{{ req.proveedor or '' }}"
               required
               class="w-full border border-slate-300 rounded px-2 py-1 text-xs">
    </div>

    <table class="min-w-full text-xs mb-3">
        <thead class="bg-slate-100">
            <tr>
                <th class="px-2 py-1 border-b">Material</th>
                <th class="px-2 py-1 border-b">C/U</th>
                <th class="px-2 py-1 border-b">Cant. a comprar</th>
            </tr>
        </thead>
        <tbody>
        {% for m in req.materiales %}
            <tr>
                <td class="px-2 py-1 border-b">
                    {{ m.descripcion }} ({{ m.cantidad }} {{ m.unidad }})
                </td>
                <td class="px-2 py-1 border-b">
                    <input type="number" name="cu_{{ m.id }}" min="0" step="0.01"
                           value="{{ m.costo_unitario or '' }}"
                           class="w-24 border border-slate-300 rounded px-1 py-1 text-xs" required>
                </td>
                <td class="px-2 py-1 border-b">
                    <input type="number" name="comprado_{{ m.id }}" min="0" max="{{ m.cantidad }}"
                           value="{{ m.comprado_qty or m.cantidad }}"
                           class="w-24 border border-slate-300 rounded px-1 py-1 text-xs" required>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="flex gap-3 text-xs">
        <label class="inline-flex items-center">
            <input type="radio" name="tipo_compra" value="total" required class="mr-1">
            Se compró TODO lo de este ID
        </label>
        <label class="inline-flex items-center">
            <input type="radio" name="tipo_compra" value="parcial" required class="mr-1">
            Se compró SOLO ciertas cantidades
        </label>
    </div>

    <div class="flex justify-end gap-2 pt-2">
        <button type="submit"
                class="px-3 py-2 text-xs rounded bg-emerald-600 text-white hover:bg-emerald-700">
            Registrar compra
        </button>
    </div>
</form>
{% endif %}

<div class="mt-4">
    <a href="{{ url_for('dashboard') }}"
       class="text-xs px-3 py-2 rounded border border-slate-300 text-slate-700 hover:bg-slate-50">
       Volver al panel
    </a>
</div>

{% endblock %}