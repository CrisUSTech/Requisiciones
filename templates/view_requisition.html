{% extends "base.html" %}
{% block title %}Requisición #{{ req.id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Requisición #{{ req.id }}</h1>
  <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">Volver</a>
</div>

<div class="row">
  <div class="col-lg-5">
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h6">Información general</h2>
        <dl class="row mb-0 small">
          <dt class="col-5">Proyecto / Tema</dt>
          <dd class="col-7">{{ req.proyecto }}</dd>

          <dt class="col-5">Área de uso</dt>
          <dd class="col-7">{{ req.area_uso or '-' }}</dd>

          <dt class="col-5">Fecha solicitud</dt>
          <dd class="col-7">{{ req.fecha_solicitud.isoformat() if req.fecha_solicitud else '-' }}</dd>

          <dt class="col-5">Fecha mantenimiento</dt>
          <dd class="col-7">{{ req.fecha_mantenimiento.isoformat() if req.fecha_mantenimiento else '-' }}</dd>

          <dt class="col-5">Prioridad</dt>
          <dd class="col-7">{{ req.prioridad }}</dd>

          <dt class="col-5">Estado</dt>
          <dd class="col-7">
            {% set e = req.estado %}
            {% set cls = "bg-secondary" %}
            {% if "Pendiente" in e %}{% set cls = "bg-warning" %}
            {% elif "Solicitado" in e %}{% set cls = "bg-primary" %}
            {% elif "Comprado" in e %}{% set cls = "bg-info" %}
            {% elif "Recibido" in e %}{% set cls = "bg-success" %}
            {% elif "Cerrado" in e %}{% set cls = "bg-dark" %}
            {% elif "No" in e %}{% set cls = "bg-danger" %}
            {% endif %}
            <span class="badge {{ cls }} text-light">{{ e }}</span>
          </dd>

          <dt class="col-5">Utilización</dt>
          <dd class="col-7">{{ req.utilizacion or '-' }}</dd>

          <dt class="col-5">Costo total</dt>
          <dd class="col-7">
            {% if req.costo_total %}
              ${{ "%.2f"|format(req.costo_total) }}
            {% else %}
              -
            {% endif %}
          </dd>

          <dt class="col-5">Proveedor(es)</dt>
          <dd class="col-7">{{ req.proveedor or '-' }}</dd>
        </dl>
      </div>
    </div>

    {% if es_autorizador(user) and not req.autorizado and req.estado == 'Pendiente Autorización' %}
    <div class="card mb-3 border-warning">
      <div class="card-body">
        <h2 class="h6 mb-2 text-warning">Autorización de Mantenimiento</h2>
        <p class="small text-muted mb-2">
          Esta requisición fue creada por mantenimiento3. Como mantenimiento1 o mantenimiento2
          puedes autorizarla para que avance a Compras/Almacén.
        </p>
        <form method="post" action="{{ url_for('autorizar_requisicion', req_id=req.id) }}">
          <button type="submit" class="btn btn-sm btn-warning">Autorizar requisición</button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="col-lg-7">
    <!-- Tabla de materiales (siempre visible) -->
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h6 mb-2">Materiales</h2>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle mb-0">
            <thead class="table-light small">
            <tr>
              <th>Descripción</th>
              <th>Cant. Solicitada</th>
              <th>Unidad</th>
              <th>Cant. Comprada</th>
              <th>CU</th>
              <th>Proveedor</th>
              <th>Recibido almacén</th>
              <th>Retirado mant.</th>
            </tr>
            </thead>
            <tbody class="small">
            {% for m in req.materiales %}
            <tr>
              <td>{{ m.descripcion }}</td>
              <td class="text-center">{{ m.cantidad }}</td>
              <td class="text-center">{{ m.unidad }}</td>
              <td class="text-center">{{ m.comprado_qty or 0 }}</td>
              <td class="text-end">
                {% if m.costo_unitario %}
                  ${{ "%.2f"|format(m.costo_unitario) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ m.proveedor or '-' }}</td>
              <td class="text-center">
                {% if m.recibido_almacen %}
                  <span class="badge bg-success">Sí</span>
                {% else %}
                  <span class="badge bg-secondary">No</span>
                {% endif %}
              </td>
              <td class="text-center">
                {% if m.no_retirado %}
                  <span class="badge bg-secondary">No retirado</span>
                {% elif m.retirado_qty %}
                  {{ m.retirado_qty }}
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Bloque COMPRAS -->
    {% if session.get("role") == "Compras" %}
    <div class="card mb-3 border-info">
      <div class="card-body">
        <h2 class="h6 mb-2 text-info">Registro de compras por material</h2>
        <p class="small text-muted mb-2">
          Define proveedor, costo unitario y cantidad comprada por cada material. Puedes marcar
          "No comprado" o "No autorizado compras" para cada renglón.
        </p>
        <form method="post" action="{{ url_for('process_compras', req_id=req.id) }}">
          <input type="hidden" name="tipo_compra" value="auto">
          <div class="table-responsive mb-2">
            <table class="table table-sm table-bordered align-middle mb-0">
              <thead class="table-light small">
              <tr>
                <th>Material</th>
                <th>Solicitado</th>
                <th>Proveedor</th>
                <th>CU</th>
                <th>Comprado</th>
                <th>No comprado</th>
                <th>No autorizado compras</th>
              </tr>
              </thead>
              <tbody class="small">
              {% for m in req.materiales %}
              <tr>
                <td>{{ m.descripcion }}</td>
                <td class="text-center">{{ m.cantidad }}</td>
                <td>
                  <input type="text" class="form-control form-control-sm"
                         name="prov_{{ m.id }}" value="{{ m.proveedor or '' }}">
                </td>
                <td>
                  <input type="number" class="form-control form-control-sm text-end"
                         step="0.01" min="0" name="cu_{{ m.id }}"
                         value="{{ m.costo_unitario or '' }}">
                </td>
                <td>
                  <input type="number" class="form-control form-control-sm text-end"
                         min="0" name="comprado_{{ m.id }}"
                         value="{{ m.comprado_qty or 0 }}">
                </td>
                <td class="text-center">
                  <input type="checkbox" name="no_comp_{{ m.id }}" value="1"
                         {% if m.no_comprado %}checked{% endif %}>
                </td>
                <td class="text-center">
                  <input type="checkbox" name="no_aut_{{ m.id }}" value="1"
                         {% if m.no_autorizado_compras %}checked{% endif %}>
                </td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          <button type="submit" class="btn btn-sm btn-info mt-2">Guardar compras</button>
        </form>
      </div>
    </div>
    {% endif %}

    <!-- Bloque ALMACÉN: recepción (checkbox llegó / no llegó) -->
    {% if session.get("role") == "Almacén" and req.estado in ['Comprado', 'Comprado (Parcial)'] %}
    <div class="card mb-3 border-success">
      <div class="card-body">
        <h2 class="h6 mb-2 text-success">Recepción en almacén</h2>
        <p class="small text-muted mb-2">
          Marca con una palomita los materiales que ya llegaron físicamente al almacén.
          El estado global se actualizará a <strong>Recibido</strong> / <strong>Recibido Parcial</strong> / <strong>No Recibido</strong>
          según lo que marques.
        </p>
        <form method="post" action="{{ url_for('process_almacen', req_id=req.id) }}">
          <div class="table-responsive mb-2">
            <table class="table table-sm table-bordered align-middle mb-0">
              <thead class="table-light small">
              <tr>
                <th>Material</th>
                <th>Cant. comprada</th>
                <th>Llegó a almacén</th>
              </tr>
              </thead>
              <tbody class="small">
              {% for m in req.materiales %}
                {% if (m.comprado_qty or 0) > 0 and not m.no_comprado and not m.no_autorizado_compras %}
                <tr>
                  <td>{{ m.descripcion }}</td>
                  <td class="text-center">{{ m.comprado_qty }}</td>
                  <td class="text-center">
                    <input type="checkbox" name="llego_{{ m.id }}" value="1"
                           {% if m.recibido_almacen %}checked{% endif %}>
                  </td>
                </tr>
                {% endif %}
              {% endfor %}
              </tbody>
            </table>
          </div>
          <button type="submit" class="btn btn-sm btn-success mt-2">
            Guardar recepción
          </button>
        </form>
      </div>
    </div>
    {% endif %}

    <!-- Bloque MANTENIMIENTO: retiro de material -->
    {% if session.get("role") == "Mantenimiento" and req.estado in ['Recibido', 'Recibido Parcial'] %}
    <div class="card mb-3 border-primary">
      <div class="card-body">
        <h2 class="h6 mb-2 text-primary">Retiro de material por Mantenimiento</h2>
        <p class="small text-muted mb-2">
          Indica cuánto material se retiró. Si de un material recibido no se tomó nada, marca "No se retiró".
          Cuando todos los materiales recibidos estén registrados, la requisición podrá cerrarse.
        </p>
        <form method="post" action="{{ url_for('procesar_retiro_mantenimiento', req_id=req.id) }}">
          <div class="table-responsive mb-2">
            <table class="table table-sm table-bordered align-middle mb-0">
              <thead class="table-light small">
              <tr>
                <th>Material</th>
                <th>Cant. recibida (comprada)</th>
                <th>Cant. retirada</th>
                <th>No se retiró</th>
              </tr>
              </thead>
              <tbody class="small">
              {% for m in req.materiales %}
                {% if m.recibido_almacen and (m.comprado_qty or 0) > 0 %}
                <tr>
                  <td>{{ m.descripcion }}</td>
                  <td class="text-center">{{ m.comprado_qty }}</td>
                  <td class="text-center">
                    <input type="number" class="form-control form-control-sm text-end"
                           name="ret_{{ m.id }}"
                           min="0" max="{{ m.comprado_qty }}"
                           value="{{ m.retirado_qty or 0 }}">
                  </td>
                  <td class="text-center">
                    <input type="checkbox" name="no_ret_{{ m.id }}" value="1"
                           {% if m.no_retirado %}checked{% endif %}>
                  </td>
                </tr>
                {% endif %}
              {% endfor %}
              </tbody>
            </table>
          </div>
          <button type="submit" class="btn btn-sm btn-primary mt-2">
            Guardar retiro
          </button>
        </form>
      </div>
    </div>
    {% endif %}

  </div>
</div>
{% endblock %}