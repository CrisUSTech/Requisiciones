{% extends "base.html" %}
{% block title %}Nueva Requisición{% endblock %}

{% block extra_head %}
<style>
  .material-row .form-control-sm {
    font-size: .8rem;
  }
</style>
{% endblock %}

{% block content %}
<h1 class="h4 mb-3">Nueva requisición</h1>

<div class="card">
  <div class="card-body">
    <form method="post" action="{{ url_for('new_requisition') }}" id="form-nueva">

      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Fecha mantenimiento</label>
          <input type="date" name="fecha_mantenimiento" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Proyecto / Tema</label>
          <input type="text" name="proyecto" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Área donde se usará</label>
          <input type="text" name="area_uso" class="form-control" placeholder="Ej. Producción, Taller...">
        </div>
        <div class="col-md-2">
          <label class="form-label">Prioridad</label>
          <select name="prioridad" class="form-select">
            <option value="Alta">Alta</option>
            <option value="Media" selected>Media</option>
            <option value="Baja">Baja</option>
          </select>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Utilización / Motivo</label>
        <textarea name="utilizacion" rows="2" class="form-control"
                  placeholder="Describe para qué se requiere el material"></textarea>
      </div>

      <hr>

      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 mb-0">Materiales solicitados</h2>
        <button type="button" class="btn btn-sm btn-outline-success" onclick="addMaterialRow()">
          + Agregar material
        </button>
      </div>

      <div id="materials-container"></div>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Guardar requisición</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Cancelar</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function createMaterialRow() {
    const div = document.createElement('div');
    div.className = 'material-row';

    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-6">
          <label class="form-label form-label-sm">Descripción del material</label>
          <input type="text" name="desc[]" class="form-control form-control-sm" required>
        </div>
        <div class="col-md-2">
          <label class="form-label form-label-sm">Cantidad</label>
          <input type="number" name="cant[]" class="form-control form-control-sm" min="1" value="1" required>
        </div>
        <div class="col-md-2">
          <label class="form-label form-label-sm">Unidad</label>
          <input type="text" name="unidad[]" class="form-control form-control-sm" placeholder="PZA, KG..." required>
        </div>
        <div class="col-md-2 text-end">
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMaterialRow(this)">
            Eliminar
          </button>
        </div>
      </div>
    `;
    return div;
  }

  function addMaterialRow() {
    const container = document.getElementById('materials-container');
    container.appendChild(createMaterialRow());
  }

  function removeMaterialRow(btn) {
    const row = btn.closest('.material-row');
    if (row) {
      row.remove();
    }
  }

  // Al cargar la página, agregamos al menos una fila
  document.addEventListener('DOMContentLoaded', () => {
    addMaterialRow();
  });
</script>
{% endblock %}