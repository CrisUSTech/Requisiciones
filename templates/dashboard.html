{% extends "base.html" %}
{% block title %}Dashboard - Sistema de Requisiciones{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Requisiciones</h1>
  {% if session.get("role") == "Mantenimiento" %}
    <a href="{{ url_for('new_requisition') }}" class="btn btn-sm btn-success">
      + Nueva requisición
    </a>
  {% endif %}
</div>

<div class="card mb-3">
  <div class="card-body">
    <form class="row gy-2 gx-3 align-items-end" method="get" action="{{ url_for('dashboard') }}">
      <div class="col-md-3">
        <label class="form-label form-label-sm">Proyecto / Tema</label>
        <input type="text" name="proyecto" class="form-control form-control-sm"
               value="{{ request.args.get('proyecto','') }}">
      </div>
      <div class="col-md-2">
        <label class="form-label form-label-sm">Prioridad</label>
        <select name="prioridad" class="form-select form-select-sm">
          <option value="">(Todas)</option>
          {% for p in ['Alta','Media','Baja'] %}
            <option value="{{ p }}" {% if request.args.get('prioridad')==p %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label form-label-sm">Fecha mant.</label>
        <input type="date" name="fecha_mantenimiento" class="form-control form-control-sm"
               value="{{ request.args.get('fecha_mantenimiento','') }}">
      </div>
      <div class="col-md-3">
        <label class="form-label form-label-sm">Estado</label>
        <select name="estado" class="form-select form-select-sm">
          <option value="">(Todos)</option>
          {% for e in estados %}
            <option value="{{ e }}" {% if request.args.get('estado')==e %}selected{% endif %}>{{ e }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 d-flex gap-2">
        <button type="submit" class="btn btn-primary btn-sm flex-grow-1">Filtrar</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">Limpiar</a>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0 align-middle">
        <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Proyecto / Tema</th>
          <th>Área</th>
          <th>Prioridad</th>
          <th>Fecha Mant.</th>
          <th>Estado</th>
          <th>Costo total</th>
          <th>Proveedor</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
        {% if requisitions %}
          {% for r in requisitions %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.proyecto }}</td>
            <td>{{ r.area_uso or '-' }}</td>
            <td>
              {% if r.prioridad == 'Alta' %}
                <span class="badge text-bg-danger">{{ r.prioridad }}</span>
              {% elif r.prioridad == 'Media' %}
                <span class="badge text-bg-warning">{{ r.prioridad }}</span>
              {% else %}
                <span class="badge text-bg-secondary">{{ r.prioridad }}</span>
              {% endif %}
            </td>
            <td>{{ r.fecha_mantenimiento.isoformat() if r.fecha_mantenimiento else '-' }}</td>
            <td>
              {% set e = r.estado %}
              {% set cls = "bg-secondary" %}
              {% if "Pendiente" in e %}{% set cls = "bg-warning" %}
              {% elif "Solicitado" in e %}{% set cls = "bg-primary" %}
              {% elif "Comprado" in e %}{% set cls = "bg-info" %}
              {% elif "Recibido" in e %}{% set cls = "bg-success" %}
              {% elif "Cerrado" in e %}{% set cls = "bg-dark" %}
              {% elif "No" in e %}{% set cls = "bg-danger" %}
              {% endif %}
              <span class="badge badge-estado {{ cls }} text-light">{{ e }}</span>
            </td>
            <td>
              {% if r.costo_total %}
                ${{ "%.2f"|format(r.costo_total) }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ r.proveedor or '-' }}</td>
            <td class="text-end">
              <a href="{{ url_for('view_requisition', req_id=r.id) }}"
                 class="btn btn-sm btn-outline-primary">
                Ver
              </a>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="9" class="text-center text-muted py-3">
              No hay requisiciones que coincidan con el filtro.
            </td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}