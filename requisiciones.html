<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Colaborativo de Requisiciones</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .table-cell-multiline {
            white-space: pre-wrap;
            word-break: break-word;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- APP -->
    <div id="app" class="hidden">
        
        <!-- HEADER -->
        <header id="app-header" class="py-4 shadow-md bg-white border-b border-blue-100">
            <div class="container mx-auto px-4 md:px-8 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i data-lucide="trending-up" class="w-6 h-6 mr-2 text-red-600"></i>
                    Sistema Colaborativo de Requisiciones
                </h1>
                <div class="flex items-center space-x-4">
                    <button id="inventory-btn" class="hidden items-center px-3 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition" onclick="openInventoryModal()">
                        <i data-lucide="boxes" class="w-4 h-4 mr-1"></i>
                        Inventario
                    </button>
                    <div id="user-info" class="flex items-center p-2 rounded-lg bg-blue-100 text-blue-800 shadow-inner border border-blue-200">
                        <i data-lucide="user" class="w-5 h-5 mr-2 text-blue-500"></i>
                        <span class="font-medium" id="current-username-display"></span>
                        <span class="ml-2 px-2 py-0.5 rounded-full text-xs font-semibold text-white bg-blue-600" id="current-role-display"></span>
                    </div>
                    <button id="logout-btn" class="flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition" onclick="logout()">
                        <i data-lucide="log-out" class="w-5 h-5 mr-2"></i>
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN -->
        <main class="container mx-auto p-4 md:p-8">
            <section class="bg-white p-6 rounded-xl shadow-2xl">
                
                <!-- Controles superiores -->
                <div class="flex flex-col gap-4 mb-6 border-b pb-4">
                    <div class="flex justify-between items-center flex-wrap gap-3">
                        <h2 class="text-xl font-semibold text-gray-700" id="dashboard-title"></h2>
                        <div class="flex flex-wrap gap-3">
                            <input
                                type="text"
                                placeholder="Búsqueda general (ID, texto)..."
                                id="search-filter"
                                oninput="renderDashboard()"
                                class="p-2 border border-gray-300 rounded-lg w-64 focus:ring-blue-500 focus:border-blue-500"
                            >
                            <button id="create-btn" class="hidden items-center bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-lg transition transform hover:scale-[1.02]" onclick="openModal('create')">
                                <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                                Nueva Requisición
                            </button>
                            <button id="csv-export-btn" class="items-center bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow-lg transition transform hover:scale-[1.02]" onclick="exportToCsv()">
                                <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                                Exportar a Excel (CSV)
                            </button>
                        </div>
                    </div>

                    <!-- Filtros por columna -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Proyecto / Tema</label>
                            <input
                                type="text"
                                id="filter-project"
                                oninput="renderDashboard()"
                                class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Filtrar por proyecto/tema"
                            >
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Prioridad</label>
                            <select
                                id="filter-priority"
                                onchange="renderDashboard()"
                                class="p-2 border border-gray-300 rounded-lg w-full bg-white focus:ring-blue-500 focus:border-blue-500"
                            >
                                <option value="">Todas</option>
                                <option value="Alta">Alta</option>
                                <option value="Media">Media</option>
                                <option value="Baja">Baja</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Fecha mant. desde</label>
                            <input
                                type="date"
                                id="filter-date-from"
                                onchange="renderDashboard()"
                                class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Fecha mant. hasta</label>
                            <input
                                type="date"
                                id="filter-date-to"
                                onchange="renderDashboard()"
                                class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Estado</label>
                            <select
                                id="filter-status"
                                onchange="renderDashboard()"
                                class="p-2 border border-gray-300 rounded-lg w-full bg-white focus:ring-blue-500 focus:border-blue-500"
                            >
                                <option value="">Todos</option>
                                <option value="Solicitado">Solicitado</option>
                                <option value="Revisado - En Stock">Revisado - En Stock</option>
                                <option value="Revisado - Autorizada">Revisado - Autorizada</option>
                                <option value="Comprado">Comprado</option>
                                <option value="Comprado (Parcial)">Comprado (Parcial)</option>
                                <option value="Finalizada">Finalizada</option>
                                <option value="Cancelada">Cancelada</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- KPIs -->
                <div id="stats-container" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <!-- Tarjetas de KPIs -->
                </div>

                <!-- Tabla -->
                <div id="requisitions-table-container" class="overflow-x-auto">
                    <!-- Tabla inyectada por JS -->
                </div>
            </section>
        </main>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-blue-600">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl space-y-6">
            <div class="text-center">
                <i data-lucide="lock" class="w-12 h-12 mx-auto text-blue-600"></i>
                <h2 class="mt-4 text-3xl font-extrabold text-gray-900">Iniciar Sesión</h2>
                <p class="mt-2 text-sm text-gray-600">Accede a tu módulo por rol</p>
                <div class="mt-4 text-xs p-2 bg-gray-100 rounded-lg border border-gray-200 text-left">
                    <p class="font-semibold text-gray-700 mb-1">Credenciales de prueba:</p>
                    <ul class="list-disc ml-4 text-gray-600">
                        <li>Mantenimiento 1: <strong>mantenimiento1 / m1</strong></li>
                        <li>Mantenimiento 2: <strong>mantenimiento2 / m2</strong></li>
                        <li>Almacén: <strong>almacen / a</strong></li>
                        <li>Compras 1: <strong>compras1 / c1</strong></li>
                        <li>Compras 2: <strong>compras2 / c2</strong></li>
                    </ul>
                </div>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div id="login-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg font-medium"></div>

                <div>
                    <label for="username" class="sr-only">Usuario</label>
                    <input id="username" name="username" type="text" autocomplete="username" required
                        class="appearance-none rounded-lg relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Nombre de Usuario">
                </div>
                <div>
                    <label for="password" class="sr-only">Contraseña</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required
                        class="appearance-none rounded-lg relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Contraseña">
                </div>

                <div>
                    <button type="submit"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                        <i data-lucide="log-in" class="w-5 h-5 mr-2"></i>
                        Ingresar al Sistema
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL GENERAL -->
    <div id="app-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl transform transition-all duration-300 scale-100">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title"></h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6" id="modal-body"></div>
        </div>
    </div>

    <!-- MODAL INVENTARIO -->
    <div id="inventory-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Inventario Global de Materiales</h3>
                <button onclick="closeInventoryModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="inventory-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg font-medium mb-4"></div>
                <div class="mb-3 flex justify-between items-center">
                    <button onclick="addInventoryRow()" class="flex items-center bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium px-3 py-2 rounded-lg">
                        <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Nuevo material
                    </button>
                    <button onclick="saveInventory()" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-3 py-2 rounded-lg">
                        <i data-lucide="save" class="w-4 h-4 mr-1"></i> Guardar cambios
                    </button>
                </div>
                <div class="max-h-80 overflow-y-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-amber-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-amber-700 uppercase tracking-wider">Descripción</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-amber-700 uppercase tracking-wider">Unidad</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-amber-700 uppercase tracking-wider">Stock</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-amber-700 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JS APP -->
    <script>
        const DB_KEY        = 'requisitions_db';
        const MATERIAL_KEY  = 'material_library';
        const INVENTORY_KEY = 'inventory_db';

        const ROLES = {
            MANTENIMIENTO: 'Mantenimiento',
            ALMACEN:       'Almacén',
            COMPRAS:       'Compras',
        };

        const CREDENTIALS = {
            "mantenimiento1": { password: "m1", role: ROLES.MANTENIMIENTO },
            "mantenimiento2": { password: "m2", role: ROLES.MANTENIMIENTO },
            "almacen":       { password: "a",  role: ROLES.ALMACEN       },
            "compras1":      { password: "c1", role: ROLES.COMPRAS       },
            "compras2":      { password: "c2", role: ROLES.COMPRAS       },
        };
        
        const ESTADOS_INFO = {
            'Solicitado':            { label: 'Solicitado',         class: 'bg-blue-100 text-blue-800',     icon: 'clock' },
            'Revisado - En Stock':   { label: 'En Stock',           class: 'bg-green-100 text-green-800',   icon: 'package' },
            'Revisado - Autorizada': { label: 'Autorizada',         class: 'bg-red-100 text-red-800',       icon: 'shopping-cart' },
            'Comprado':              { label: 'Comprado',           class: 'bg-purple-100 text-purple-800', icon: 'check-circle' },
            'Comprado (Parcial)':    { label: 'Comprado (Parcial)', class: 'bg-purple-50 text-purple-900',  icon: 'circle-dot' },
            'Finalizada':            { label: 'Finalizada',         class: 'bg-gray-100 text-gray-800',     icon: 'check' },
            'Cancelada':             { label: 'Cancelada',          class: 'bg-gray-200 text-gray-600',     icon: 'slash' },
        };

        let currentUserId = null;
        let currentRole   = null;
        let requisitionToProcess = null;

        // --- UTILIDADES BASE DE DATOS ---

        const loadData = (key) => {
            try {
                const raw = localStorage.getItem(key);
                let data;
                if (!raw) {
                    if (key === DB_KEY)        return [];
                    if (key === INVENTORY_KEY) return {};
                    if (key === MATERIAL_KEY)  return {};
                    return null;
                }
                data = JSON.parse(raw);

                if (key === DB_KEY) {
                    if (!Array.isArray(data)) data = [];
                    data.forEach(req => {
                        req.materiales = (req.materiales || []).map(mat => ({
                            ...mat,
                            revisado_qty:   mat.revisado_qty    || 0,
                            stock_available:mat.stock_available || 0,
                            costo_unitario: mat.costo_unitario  || 0.0,
                            comprado_qty:   mat.comprado_qty    || 0,
                        }));
                        req.comentarios       = Array.isArray(req.comentarios) ? req.comentarios : [];
                        req.fecha_finalizacion= req.fecha_finalizacion || null;
                        req.finalizado_por    = req.finalizado_por   || null;
                    });
                } else if (key === INVENTORY_KEY) {
                    if (typeof data !== 'object' || Array.isArray(data) || data === null) data = {};
                } else if (key === MATERIAL_KEY) {
                    if (typeof data !== 'object' || Array.isArray(data) || data === null) data = {};
                }
                return data;
            } catch (e) {
                console.error("Error al cargar", key, e);
                if (key === DB_KEY)        return [];
                if (key === INVENTORY_KEY) return {};
                if (key === MATERIAL_KEY)  return {};
                return null;
            }
        };

        const saveData = (key, data) => {
            localStorage.setItem(key, JSON.stringify(data));
        };

        const ensureDatabase = () => {
            if (!localStorage.getItem(DB_KEY))        saveData(DB_KEY, []);
            if (!localStorage.getItem(MATERIAL_KEY))  saveData(MATERIAL_KEY, {});
            if (!localStorage.getItem(INVENTORY_KEY)) saveData(INVENTORY_KEY, {});
        };

        const generateId = (requisitions) => {
            if (!requisitions || requisitions.length === 0) return 1;
            return Math.max(...requisitions.map(r => r.id)) + 1;
        };

        const isValidDate = (dateString) => {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return false;
            const date = new Date(dateString);
            return date.toISOString().slice(0, 10) === dateString;
        };

        const getCurrentDate = () => new Date().toISOString().split('T')[0];

        // --- LOGIN / LOGOUT ---

        const handleLogin = (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            const userData = CREDENTIALS[username];

            if (userData && userData.password === password) {
                currentUserId = username;
                currentRole   = userData.role;
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                initializeApp();
            } else {
                errorDiv.textContent = 'Usuario o contraseña incorrectos. Intente de nuevo.';
                errorDiv.classList.remove('hidden');
            }
        };

        const logout = () => {
            currentUserId = null;
            currentRole   = null;
            document.getElementById('app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').classList.add('hidden');
            lucide.createIcons(); 
        };

        const initializeApp = () => {
            ensureDatabase();
            document.getElementById('current-username-display').textContent = currentUserId;
            document.getElementById('current-role-display').textContent     = currentRole;
            
            const createBtn    = document.getElementById('create-btn');
            const inventoryBtn = document.getElementById('inventory-btn');

            if (currentRole === ROLES.MANTENIMIENTO) {
                createBtn.classList.remove('hidden');
                createBtn.classList.add('flex');
            } else {
                createBtn.classList.add('hidden');
                createBtn.classList.remove('flex');
            }

            if (currentRole === ROLES.ALMACEN || currentRole === ROLES.COMPRAS) {
                inventoryBtn.classList.remove('hidden');
                inventoryBtn.classList.add('flex');
            } else {
                inventoryBtn.classList.add('hidden');
                inventoryBtn.classList.remove('flex');
            }
            
            renderDashboard();
            lucide.createIcons(); 
        };

        // --- FILTROS / TABLA / KPIs ---

        const filterRequisitions = (allReqs) => {
            let list = allReqs || [];

            const textFilter     = (document.getElementById('search-filter')?.value || '').toLowerCase();
            const projectFilter  = (document.getElementById('filter-project')?.value || '').toLowerCase();
            const priorityFilter = (document.getElementById('filter-priority')?.value || '');
            const statusFilter   = (document.getElementById('filter-status')?.value || '');
            const dateFrom       = (document.getElementById('filter-date-from')?.value || '');
            const dateTo         = (document.getElementById('filter-date-to')?.value || '');

            // Filtro por rol
            if (currentRole === ROLES.ALMACEN) {
                list = list.filter(r => r.estado === 'Solicitado');
            } else if (currentRole === ROLES.COMPRAS) {
                list = list.filter(r =>
                    r.estado === 'Revisado - Autorizada' ||
                    r.estado === 'Comprado' ||
                    r.estado === 'Comprado (Parcial)'
                );
            } else if (currentRole === ROLES.MANTENIMIENTO) {
                list = list.filter(r => r.solicitante_id === currentUserId);
            }

            // Filtros por columna
            if (projectFilter) {
                list = list.filter(r => (r.proyecto || '').toLowerCase().includes(projectFilter));
            }
            if (priorityFilter) {
                list = list.filter(r => r.prioridad === priorityFilter);
            }
            if (statusFilter) {
                list = list.filter(r => r.estado === statusFilter);
            }
            if (dateFrom) {
                list = list.filter(r => r.fecha_mantenimiento >= dateFrom);
            }
            if (dateTo) {
                list = list.filter(r => r.fecha_mantenimiento <= dateTo);
            }

            // Búsqueda general
            if (textFilter) {
                list = list.filter(r =>
                    (r.proyecto || '').toLowerCase().includes(textFilter) ||
                    (r.prioridad || '').toLowerCase().includes(textFilter) ||
                    (r.estado || '').toLowerCase().includes(textFilter) ||
                    r.id.toString().includes(textFilter)
                );
            }

            const priorityOrder = { 'Alta': 1, 'Media': 2, 'Baja': 3 };
            list.sort((a, b) => {
                if (a.estado === 'Solicitado' && b.estado !== 'Solicitado') return -1;
                if (a.estado === 'Revisado - Autorizada' && b.estado !== 'Revisado - Autorizada' && b.estado !== 'Solicitado') return -1;
                return (priorityOrder[a.prioridad] || 4) - (priorityOrder[b.prioridad] || 4);
            });

            return list;
        };

        const calculateTotalCost = (req) => {
            return (req.materiales || []).reduce((sum, mat) => {
                return sum + (mat.costo_unitario || 0) * (mat.comprado_qty || 0);
            }, 0);
        };

        const computeStats = (reqs) => {
            const total = reqs.length;
            const abiertas = reqs.filter(r => r.estado !== 'Finalizada' && r.estado !== 'Cancelada').length;
            const now = new Date();
            const ms30d = 30 * 24 * 60 * 60 * 1000;
            const last30 = new Date(now.getTime() - ms30d);
            const last30Str = last30.toISOString().slice(0, 10);

            let costo30 = 0;
            reqs.forEach(r => {
                if (r.fecha_solicitud && r.fecha_solicitud >= last30Str) {
                    costo30 += calculateTotalCost(r);
                }
            });

            const solicitadas = reqs.filter(r => r.estado === 'Solicitado').length;
            const autorizadas = reqs.filter(r => r.estado === 'Revisado - Autorizada').length;
            const compradas   = reqs.filter(r => r.estado === 'Comprado' || r.estado === 'Comprado (Parcial)').length;
            const finalizadas = reqs.filter(r => r.estado === 'Finalizada').length;

            return { total, abiertas, costo30, solicitadas, autorizadas, compradas, finalizadas };
        };

        const renderStats = (stats) => {
            const c = document.getElementById('stats-container');
            const fmt = (n) => n.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            const fmtMoney = (n) => n.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });

            c.innerHTML = `
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                    <p class="text-xs text-blue-600 font-semibold">Requisiciones abiertas</p>
                    <p class="text-2xl font-bold text-blue-900">${fmt(stats.abiertas)}</p>
                    <p class="text-xs text-gray-500 mt-1">Total: ${fmt(stats.total)}</p>
                </div>
                <div class="bg-emerald-50 border border-emerald-100 rounded-lg p-4">
                    <p class="text-xs text-emerald-600 font-semibold">Compradas</p>
                    <p class="text-2xl font-bold text-emerald-900">${fmt(stats.compradas)}</p>
                    <p class="text-xs text-gray-500 mt-1">Finalizadas: ${fmt(stats.finalizadas)}</p>
                </div>
                <div class="bg-amber-50 border border-amber-100 rounded-lg p-4">
                    <p class="text-xs text-amber-600 font-semibold">Solicitadas / Autorizadas</p>
                    <p class="text-2xl font-bold text-amber-900">${fmt(stats.solicitadas + stats.autorizadas)}</p>
                    <p class="text-xs text-gray-500 mt-1">Sol: ${fmt(stats.solicitadas)}, Aut: ${fmt(stats.autorizadas)}</p>
                </div>
                <div class="bg-purple-50 border border-purple-100 rounded-lg p-4">
                    <p class="text-xs text-purple-600 font-semibold">Gasto últimos 30 días</p>
                    <p class="text-2xl font-bold text-purple-900">${fmtMoney(stats.costo30)}</p>
                    <p class="text-xs text-gray-500 mt-1">Compras registradas</p>
                </div>
            `;
        };

        const renderDashboard = () => {
            const allReqs = loadData(DB_KEY);
            const filteredReqs = filterRequisitions(allReqs);
            const container    = document.getElementById('requisitions-table-container');
            const titleElement = document.getElementById('dashboard-title');
            
            let title;
            if (currentRole === ROLES.MANTENIMIENTO) title = 'Mis Requisiciones';
            else if (currentRole === ROLES.ALMACEN) title = 'Requisiciones para Revisión (Almacén)';
            else if (currentRole === ROLES.COMPRAS) title = 'Requisiciones para Compra y Seguimiento';
            titleElement.textContent = title;

            renderStats(computeStats(filteredReqs));

            if (!filteredReqs || filteredReqs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 bg-gray-50 rounded-xl border border-dashed text-gray-500">
                        <i data-lucide="inbox" class="w-10 h-10 mx-auto mb-3"></i>
                        <p class="font-medium">No hay requisiciones disponibles o que coincidan con los filtros.</p>
                        ${currentRole === ROLES.MANTENIMIENTO ? '<p class="text-sm mt-2">Usa el botón "Nueva Requisición" para comenzar.</p>' : ''}
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = generateTableHTML(filteredReqs);
            lucide.createIcons();
        };

        const generateTableHTML = (requisitions) => {
            const headers = [
                "ID", "Proyecto/Tema", "Prioridad", "Fecha Mant.", "Materiales", "Costo Total", "Estado", "Trazabilidad", "Acciones"
            ];

            return `
                <table class="min-w-full divide-y divide-gray-200 shadow-lg rounded-xl overflow-hidden">
                    <thead class="bg-blue-100">
                        <tr>
                            ${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${requisitions.map(req => generateTableRow(req)).join('')}
                    </tbody>
                </table>
            `;
        };

        const generateTableRow = (req) => {
            const totalCost  = calculateTotalCost(req);
            const statusInfo = ESTADOS_INFO[req.estado] || ESTADOS_INFO['Solicitado'];
            const costDisplay= totalCost > 0 ? `$${totalCost.toFixed(2)}` : 'N/A';
            
            const today = getCurrentDate();
            const daysDiff = (new Date(req.fecha_mantenimiento) - new Date(today)) / (1000*60*60*24);
            let dateClass = 'text-gray-500';
            if (daysDiff <= 2)      dateClass = 'text-red-600 font-semibold';
            else if (daysDiff <= 7) dateClass = 'text-amber-600 font-semibold';

            const materialsSummary = (req.materiales || []).map(m => {
                const stock       = m.stock_available || 0;
                const yaComprado  = m.comprado_qty   || 0;
                const pendiente   = Math.max(m.cantidad - stock - yaComprado, 0);
                let summary = `${m.cantidad} ${m.unidad} - ${m.descripcion}`;
                if (m.revisado_qty > 0) {
                    summary += ` (Rev: ${m.revisado_qty} / Stock: ${stock})`;
                }
                if (pendiente > 0) {
                    summary += ` [Pend.: ${pendiente}]`;
                }
                if (yaComprado > 0) {
                    summary += ` [Comprado: ${yaComprado} C/U: $${(m.costo_unitario || 0).toFixed(2)}]`;
                }
                return summary;
            }).join('\n');

            const trazabilidadDisplay = req.revisado_por 
                ? `${req.revisado_por} el ${(req.fecha_revision || '').split(' ')[0]}`
                : 'Pendiente';

            // Acciones
            const actions = [];

            // Comentarios: disponible para todos
            actions.push(
                `<button onclick="openModal('comentarios', ${req.id})" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-2 py-1 text-xs rounded-lg font-medium mr-1">
                    <i data-lucide="message-circle" class="w-3 h-3 inline-block mr-1"></i>Comentarios
                 </button>`
            );

            if (currentRole === ROLES.ALMACEN && req.estado === 'Solicitado') {
                actions.push(
                    `<button onclick="openModal('almacen', ${req.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-xs rounded-lg font-medium mr-1">
                        Revisar
                     </button>`
                );
            }

            if (currentRole === ROLES.COMPRAS && (req.estado === 'Revisado - Autorizada' || req.estado === 'Comprado (Parcial)')) {
                actions.push(
                    `<button onclick="openModal('compras', ${req.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 text-xs rounded-lg font-medium mr-1">
                        Registrar Compra
                     </button>`
                );
            }

            if (currentRole === ROLES.MANTENIMIENTO && req.solicitante_id === currentUserId) {
                if (req.estado === 'Solicitado') {
                    actions.push(
                        `<button onclick="openModal('edit', ${req.id})" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-xs rounded-lg font-medium mr-1">
                            Editar
                         </button>`
                    );
                    actions.push(
                        `<button onclick="cancelRequisition(${req.id})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 text-xs rounded-lg font-medium">
                            Cancelar
                         </button>`
                    );
                } else if ((req.estado === 'Comprado' || req.estado === 'Comprado (Parcial)') && req.estado !== 'Finalizada') {
                    actions.push(
                        `<button onclick="openModal('finalizar', ${req.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 text-xs rounded-lg font-medium">
                            Finalizar
                         </button>`
                    );
                }
            }

            const actionsHTML = actions.length ? actions.join('') : `<span class="text-gray-400 text-xs">Sin acciones</span>`;

            return `
                <tr class="hover:bg-blue-50 transition-colors">
                    <td class="px-6 py-3 text-sm font-semibold text-gray-900">${req.id}</td>
                    <td class="px-6 py-3 text-sm text-gray-800 font-medium">${req.proyecto}</td>
                    <td class="px-6 py-3 text-sm">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            req.prioridad === 'Alta' ? 'bg-red-100 text-red-800' :
                            req.prioridad === 'Media' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${req.prioridad}
                        </span>
                    </td>
                    <td class="px-6 py-3 text-sm font-medium ${dateClass}">${req.fecha_mantenimiento}</td>
                    <td class="px-6 py-3 text-xs text-gray-600 table-cell-multiline">${materialsSummary}</td>
                    <td class="px-6 py-3 text-sm font-bold text-gray-900">${costDisplay}</td>
                    <td class="px-6 py-3 text-sm">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusInfo.class}">
                            <i data-lucide="${statusInfo.icon}" class="w-3 h-3 mr-1"></i>
                            ${statusInfo.label}
                        </span>
                    </td>
                    <td class="px-6 py-3 text-xs text-gray-500">
                        ${trazabilidadDisplay}
                        ${req.estado === 'Finalizada' && req.fecha_finalizacion ? `<br><span class="text-[10px] text-green-700">Finalizada por ${req.finalizado_por} el ${req.fecha_finalizacion.split(' ')[0]}</span>` : ''}
                    </td>
                    <td class="px-6 py-3 text-right text-sm font-medium whitespace-nowrap">${actionsHTML}</td>
                </tr>
            `;
        };

        // --- MODALES GENERALES ---

        const openModal = (type, reqId = null) => {
            const modal = document.getElementById('app-modal');
            const title = document.getElementById('modal-title');
            const body  = document.getElementById('modal-body');

            requisitionToProcess = null;
            if (reqId) {
                const allReqs = loadData(DB_KEY);
                requisitionToProcess = allReqs.find(r => r.id === reqId);
            }

            if (type === 'create') {
                title.textContent = 'Crear Nueva Requisición (Mantenimiento)';
                body.innerHTML    = generateCreateForm();
            } else if (type === 'edit' && requisitionToProcess) {
                title.textContent = `Editar Requisición #${requisitionToProcess.id}`;
                body.innerHTML    = generateEditForm(requisitionToProcess);
            } else if (type === 'almacen' && requisitionToProcess) {
                title.textContent = `Revisión por Pieza #${requisitionToProcess.id} - ${requisitionToProcess.proyecto}`;
                body.innerHTML    = generateAlmacenForm(requisitionToProcess);
            } else if (type === 'compras' && requisitionToProcess) {
                title.textContent = `Registrar Compra #${requisitionToProcess.id}`;
                body.innerHTML    = generateComprasForm(requisitionToProcess);
            } else if (type === 'comentarios' && requisitionToProcess) {
                title.textContent = `Comentarios Requisición #${requisitionToProcess.id}`;
                body.innerHTML    = generateComentariosForm(requisitionToProcess);
            } else if (type === 'finalizar' && requisitionToProcess) {
                title.textContent = `Finalizar Requisición #${requisitionToProcess.id}`;
                body.innerHTML    = generateFinalizarForm(requisitionToProcess);
            } else {
                return;
            }

            modal.classList.remove('hidden');
            lucide.createIcons();
        };

        const closeModal = () => {
            document.getElementById('app-modal').classList.add('hidden');
            requisitionToProcess = null;
            renderDashboard();
        };

        // --- FORMULARIOS DE CREACIÓN / EDICIÓN ---

        const generateInputField = (type, name, label, value = '', required = false, isMaterial = false, step = null) => {
            const inputId = isMaterial ? `material-${name}` : name;
            return `
                <div class="flex flex-col">
                    <label for="${inputId}" class="text-sm font-medium text-gray-700 mb-1">${label}${required ? '<span class="text-red-500">*</span>' : ''}</label>
                    <input id="${inputId}" name="${name}" type="${type}" value="${value}" ${step ? `step="${step}"` : ''}
                        class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" ${required ? 'required' : ''}>
                </div>
            `;
        };

        let materialIndex = 1;

        const generateMaterialField = (index, mat = null) => {
            materialIndex++;
            const desc  = mat ? mat.descripcion : '';
            const qty   = mat ? mat.cantidad    : 1;
            const unit  = mat ? mat.unidad      : 'PZA';
            return `
                <div id="material-field-${index}" class="material-row flex space-x-2 bg-gray-50 p-3 rounded-lg border">
                    <div class="flex-grow">
                        ${generateInputField('text', `desc-${index}`, 'Descripción', desc, true, true)}
                    </div>
                    <div class="w-24">
                        ${generateInputField('number', `qty-${index}`, 'Cantidad', qty, true, true, '1')}
                    </div>
                    <div class="w-24">
                        ${generateInputField('text', `unit-${index}`, 'Unidad', unit, true, true)}
                    </div>
                    <button type="button" onclick="removeMaterialField(${index})" class="self-end p-2 text-red-500 hover:text-red-700">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
        };

        const generateCreateForm = () => {
            return `
                <form id="create-requisition-form" onsubmit="handleCreateSubmit(event)">
                    <div id="form-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg font-medium mb-4"></div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        ${generateInputField('date', 'fecha_mantenimiento', 'Fecha Mantenimiento (YYYY-MM-DD)', getCurrentDate(), true)}
                        ${generateInputField('text', 'proyecto', 'Tema o Proyecto', '', true)}
                    </div>
                    
                    <div class="mb-4">
                        ${generateInputField('text', 'utilizacion', 'Utilización o Propósito', '', false)}
                    </div>

                    <div class="mb-4">
                        <label for="prioridad" class="text-sm font-medium text-gray-700 mb-1">Prioridad<span class="text-red-500">*</span></label>
                        <select id="prioridad" name="prioridad" class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500 bg-white" required>
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                            <option value="Baja">Baja</option>
                        </select>
                    </div>

                    <div class="border-t pt-4">
                        <h4 class="font-semibold mb-3 flex justify-between items-center text-gray-700">
                            Materiales Requisitados
                            <button type="button" onclick="addMaterialField()" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Añadir Material
                            </button>
                        </h4>
                        <div id="materiales-container" class="space-y-3 max-h-48 overflow-y-auto pr-2">
                            ${generateMaterialField(1)}
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-6">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>Guardar Requisición
                        </button>
                    </div>
                </form>
            `;
        };

        const generateEditForm = (req) => {
            materialIndex = 1;
            const matsHTML = (req.materiales || []).map((m, i) => generateMaterialField(i+1, m)).join('');
            return `
                <form id="edit-requisition-form" onsubmit="handleEditSubmit(event, ${req.id})">
                    <div id="edit-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg font-medium mb-4"></div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        ${generateInputField('date', 'fecha_mantenimiento', 'Fecha Mantenimiento (YYYY-MM-DD)', req.fecha_mantenimiento, true)}
                        ${generateInputField('text', 'proyecto', 'Tema o Proyecto', req.proyecto, true)}
                    </div>
                    
                    <div class="mb-4">
                        ${generateInputField('text', 'utilizacion', 'Utilización o Propósito', req.utilizacion || '', false)}
                    </div>

                    <div class="mb-4">
                        <label for="prioridad" class="text-sm font-medium text-gray-700 mb-1">Prioridad<span class="text-red-500">*</span></label>
                        <select id="prioridad" name="prioridad" class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500 bg-white" required>
                            <option value="Alta" ${req.prioridad === 'Alta' ? 'selected' : ''}>Alta</option>
                            <option value="Media" ${req.prioridad === 'Media' ? 'selected' : ''}>Media</option>
                            <option value="Baja" ${req.prioridad === 'Baja' ? 'selected' : ''}>Baja</option>
                        </select>
                    </div>

                    <div class="border-t pt-4">
                        <h4 class="font-semibold mb-3 flex justify-between items-center text-gray-700">
                            Materiales Requisitados
                            <button type="button" onclick="addMaterialField()" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Añadir Material
                            </button>
                        </h4>
                        <div id="materiales-container" class="space-y-3 max-h-48 overflow-y-auto pr-2">
                            ${matsHTML}
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-6">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i>Guardar cambios
                        </button>
                    </div>
                </form>
            `;
        };

        const addMaterialField = () => {
            const container = document.getElementById('materiales-container');
            container.insertAdjacentHTML('beforeend', generateMaterialField(materialIndex));
            lucide.createIcons();
        };

        const removeMaterialField = (index) => {
            const element = document.getElementById(`material-field-${index}`);
            if (element) element.remove();
        };

        const collectMaterialsFromForm = (form, errorDivId) => {
            const errorDiv = document.getElementById(errorDivId);
            const rows     = form.querySelectorAll('.material-row');
            const materiales = [];
            const materialLibrary = loadData(MATERIAL_KEY);
            let validCount = 0;

            rows.forEach(row => {
                const idx  = row.id.split('-')[2];
                const desc = row.querySelector(`[name="desc-${idx}"]`).value.trim();
                const qty  = parseInt(row.querySelector(`[name="qty-${idx}"]`).value);
                const unit = row.querySelector(`[name="unit-${idx}"]`).value.trim();

                if (desc && qty > 0 && unit) {
                    materiales.push({
                        descripcion: desc,
                        cantidad: qty,
                        unidad: unit,
                        revisado_qty: 0,
                        stock_available: 0,
                        costo_unitario: 0.0,
                        comprado_qty: 0
                    });
                    validCount++;
                    materialLibrary[desc] = unit;
                }
            });

            if (validCount === 0) {
                errorDiv.textContent = 'Debe agregar al menos un material válido con descripción, cantidad y unidad.';
                errorDiv.classList.remove('hidden');
                return null;
            }

            saveData(MATERIAL_KEY, materialLibrary);
            return materiales;
        };

        const handleCreateSubmit = (e) => {
            e.preventDefault();
            const form     = e.target;
            const errorDiv = document.getElementById('form-error');
            errorDiv.classList.add('hidden');

            const fecha_mantenimiento = form.fecha_mantenimiento.value;
            const proyecto  = form.proyecto.value.trim();
            const utilizacion = form.utilizacion.value.trim();
            const prioridad = form.prioridad.value;

            if (!isValidDate(fecha_mantenimiento)) {
                errorDiv.textContent = 'Formato de Fecha de Mantenimiento no válido (YYYY-MM-DD).';
                errorDiv.classList.remove('hidden');
                return;
            }

            const materiales = collectMaterialsFromForm(form, 'form-error');
            if (!materiales) return;

            const allReqs = loadData(DB_KEY);
            const newReq  = {
                id: generateId(allReqs),
                fecha_solicitud: getCurrentDate(),
                fecha_mantenimiento,
                proyecto,
                utilizacion,
                prioridad,
                materiales,
                estado: 'Solicitado',
                solicitante_id: currentUserId,
                proveedor: null,
                costo: 0.0,
                revisado_por: null,
                fecha_revision: null,
                comentarios: [],
                fecha_finalizacion: null,
                finalizado_por: null
            };

            allReqs.push(newReq);
            saveData(DB_KEY, allReqs);
            closeModal();
        };

        const handleEditSubmit = (e, id) => {
            e.preventDefault();
            const form     = e.target;
            const errorDiv = document.getElementById('edit-error');
            errorDiv.classList.add('hidden');

            const fecha_mantenimiento = form.fecha_mantenimiento.value;
            const proyecto  = form.proyecto.value.trim();
            const utilizacion = form.utilizacion.value.trim();
            const prioridad = form.prioridad.value;

            if (!isValidDate(fecha_mantenimiento)) {
                errorDiv.textContent = 'Formato de Fecha de Mantenimiento no válido (YYYY-MM-DD).';
                errorDiv.classList.remove('hidden');
                return;
            }

            const materiales = collectMaterialsFromForm(form, 'edit-error');
            if (!materiales) return;

            const allReqs = loadData(DB_KEY);
            const index   = allReqs.findIndex(r => r.id === id);
            if (index === -1) return;

            const req = allReqs[index];
            if (req.estado !== 'Solicitado' || req.solicitante_id !== currentUserId) {
                errorDiv.textContent = 'Solo se pueden editar requisiciones en estado "Solicitado".';
                errorDiv.classList.remove('hidden');
                return;
            }

            allReqs[index] = {
                ...req,
                fecha_mantenimiento,
                proyecto,
                utilizacion,
                prioridad,
                materiales
            };

            saveData(DB_KEY, allReqs);
            closeModal();
        };

        const cancelRequisition = (id) => {
            if (!confirm('¿Seguro que deseas cancelar esta requisición?')) return;
            const allReqs = loadData(DB_KEY);
            const index   = allReqs.findIndex(r => r.id === id);
            if (index === -1) return;

            if (currentRole !== ROLES.MANTENIMIENTO || allReqs[index].solicitante_id !== currentUserId || allReqs[index].estado !== 'Solicitado') {
                alert('Solo puedes cancelar tus requisiciones en estado "Solicitado".');
                return;
            }

            allReqs[index].estado = 'Cancelada';
            saveData(DB_KEY, allReqs);
            renderDashboard();
        };

        // --- FORMULARIO ALMACÉN (usa inventario global, descuenta stock) ---

        const generateAlmacenForm = (req) => {
            const inv = loadData(INVENTORY_KEY);
            return `
                <form id="almacen-process-form" onsubmit="handleAlmacenProcess(event, ${req.id})">
                    <div id="almacen-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg font-medium mb-4"></div>
                    
                    <p class="text-sm text-gray-700 mb-4 font-semibold">
                        Almacén solo revisa: indique cuántas piezas revisó y cuántas puede entregar desde stock (no puede exceder el inventario).
                    </p>

                    <div class="space-y-4 max-h-72 overflow-y-auto pr-2">
                        <div class="grid grid-cols-8 gap-3 font-semibold text-xs text-blue-700 border-b pb-2 sticky top-0 bg-white">
                            <div class="col-span-3">Material</div>
                            <div>Solicitado</div>
                            <div>En inventario</div>
                            <div>Revisado</div>
                            <div>Entrega stock</div>
                            <div>Pendiente</div>
                        </div>
                        ${(req.materiales || []).map((mat, index) => {
                            const invItem = inv[mat.descripcion] || { unidad: mat.unidad, stock: 0 };
                            const stockGlobal = invItem.stock || 0;
                            const stockLocal  = mat.stock_available || 0;
                            const yaComprado  = mat.comprado_qty   || 0;
                            const pendiente   = Math.max(mat.cantidad - stockLocal - yaComprado, 0);
                            return `
                                <div class="grid grid-cols-8 gap-3 items-center border-b pb-3">
                                    <div class="col-span-3 text-sm text-gray-800">${mat.descripcion} (${mat.unidad})</div>
                                    <div class="text-sm font-bold text-red-600">${mat.cantidad}</div>
                                    <div class="text-sm font-semibold text-indigo-700">${stockGlobal}</div>
                                    <div>
                                        <input type="number" name="rev_qty_${index}" value="${mat.revisado_qty || 0}" min="0" max="${mat.cantidad}"
                                            class="w-full p-1 border border-gray-300 rounded-lg text-sm text-center focus:ring-blue-500 focus:border-blue-500" required>
                                    </div>
                                    <div>
                                        <input type="number" name="stock_qty_${index}" value="${stockLocal}" min="0" max="${stockGlobal}"
                                            class="w-full p-1 border border-gray-300 rounded-lg text-sm text-center focus:ring-blue-500 focus:border-blue-500" required>
                                    </div>
                                    <div class="text-sm font-semibold ${pendiente > 0 ? 'text-red-600' : 'text-green-700'}">
                                        ${pendiente > 0 ? pendiente : '0'}
                                    </div>
                                    <input type="hidden" name="mat_index" value="${index}">
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <p class="mt-4 text-xs text-gray-500">
                        Nota: Se descuenta del inventario global la cantidad que se entrega desde stock. Si quedan piezas pendientes, el estado será "Revisado - Autorizada" para que Compras gestione la compra.
                    </p>

                    <div class="flex justify-between space-x-3 pt-6 border-t mt-6">
                        <button type="submit" data-action="auto"
                            class="flex-1 flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg shadow-md transition">
                            <i data-lucide="check-square" class="w-5 h-5 mr-2"></i> Guardar revisión
                        </button>
                    </div>
                </form>
            `;
        };
        
        const handleAlmacenProcess = (e, id) => {
            e.preventDefault();
            const form = e.target;
            const errorDiv = document.getElementById('almacen-error');
            errorDiv.classList.add('hidden');

            const allReqs = loadData(DB_KEY);
            const inv     = loadData(INVENTORY_KEY);
            const reqIndex= allReqs.findIndex(r => r.id === id);
            if (reqIndex === -1) return;

            try {
                const updatedMaterials = allReqs[reqIndex].materiales.map((mat, index) => {
                    const revQty   = parseInt(form[`rev_qty_${index}`].value)   || 0;
                    const stockQty = parseInt(form[`stock_qty_${index}`].value) || 0;

                    if (revQty > mat.cantidad || revQty < 0 || stockQty < 0) {
                        throw new Error('Revise las cantidades (revisada no debe exceder solicitada, y ninguna debe ser negativa).');
                    }

                    const invItem = inv[mat.descripcion] || { unidad: mat.unidad, stock: 0 };
                    if (stockQty > invItem.stock) {
                        throw new Error(`No hay suficiente inventario para "${mat.descripcion}". Stock disponible: ${invItem.stock}.`);
                    }

                    // Descontar del inventario global lo entregado desde stock
                    invItem.stock -= stockQty;
                    inv[mat.descripcion] = invItem;

                    return {
                        ...mat,
                        revisado_qty: revQty,
                        stock_available: stockQty,
                    };
                });

                allReqs[reqIndex].materiales = updatedMaterials;

                const hayPendientes = updatedMaterials.some(m =>
                    Math.max(m.cantidad - (m.stock_available || 0) - (m.comprado_qty || 0), 0) > 0
                );

                allReqs[reqIndex].estado = hayPendientes ? 'Revisado - Autorizada' : 'Revisado - En Stock';
                allReqs[reqIndex].revisado_por   = currentUserId;
                allReqs[reqIndex].fecha_revision = new Date().toISOString().split('T')[0] + ' ' + new Date().toLocaleTimeString();

                saveData(DB_KEY, allReqs);
                saveData(INVENTORY_KEY, inv);
                closeModal();
            } catch (err) {
                errorDiv.textContent = 'Error: ' + err.message;
                errorDiv.classList.remove('hidden');
            }
        };

        // --- FORMULARIO COMPRAS (compra total/parcial, sin tocar inventario global) ---

        const generateComprasForm = (req) => {
            const materialesHtml = (req.materiales || []).map((mat, index) => {
                const stock      = mat.stock_available || 0;
                const yaComprado = mat.comprado_qty   || 0;
                const pendiente  = Math.max(mat.cantidad - stock - yaComprado, 0);
                const requiereCompra = pendiente > 0;

                return `
                    <div class="flex flex-col border-b pb-3 mb-2">
                        <div class="flex justify-between text-sm text-gray-800">
                            <div class="w-1/2">
                                <span class="font-semibold">${mat.descripcion}</span> (${mat.unidad})
                                <div class="text-xs text-gray-500 mt-1">
                                    Solicitado: <strong>${mat.cantidad}</strong> |
                                    Stock usado: <strong>${stock}</strong> |
                                    Ya comprado: <strong>${yaComprado}</strong> |
                                    Pendiente: <strong class="${pendiente > 0 ? 'text-red-600' : 'text-green-700'}">${pendiente}</strong>
                                </div>
                            </div>
                            <div class="w-1/2 flex items-center justify-end gap-2">
                                ${requiereCompra ? `
                                    <input type="checkbox" name="comprado_${index}" class="w-4 h-4 mr-1">
                                    <span class="text-xs text-gray-700 mr-3">Comprar este material</span>
                                    <input type="number" name="costo_unitario_${index}" value="${mat.costo_unitario || ''}" min="0.01" step="0.01"
                                        class="w-28 p-2 border border-gray-300 rounded-lg text-sm focus:ring-red-500 focus:border-red-500" placeholder="C/U ($)">
                                ` : `
                                    <span class="text-xs text-green-700 italic">No requiere compra (stock + compras cubren todo)</span>
                                `}
                            </div>
                        </div>
                        <input type="hidden" name="mat_index" value="${index}">
                    </div>
                `;
            }).join('');

            return `
                <form id="purchase-form" onsubmit="handleComprasSubmit(event, ${req.id})">
                    <div id="compras-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg font-medium mb-4"></div>
                    
                    <div class="text-sm text-gray-700 mb-6 border p-4 rounded-lg bg-red-50">
                        <p class="font-semibold mb-1">Info de Trazabilidad:</p>
                        <p>Revisado por: <span class="font-bold">${req.revisado_por}</span> el <span class="font-bold">${(req.fecha_revision || '').split(' ')[0]}</span></p>
                        <p class="mt-2 text-red-600 font-bold">Fecha Mantenimiento: ${req.fecha_mantenimiento}</p>
                        <p class="mt-1 text-xs text-gray-700">
                            Compras solo compra lo pendiente (Solicitado − Stock usado − Comprado).
                        </p>
                    </div>

                    <div class="mb-4">
                        ${generateInputField('text', 'proveedor', 'Proveedor', req.proveedor || '', true)}
                    </div>

                    <div class="mb-4">
                        <label class="text-sm font-medium text-gray-700 mb-1">¿Qué se compró?</label>
                        <select name="purchase_mode" class="p-2 border border-gray-300 rounded-lg w-full bg-white focus:ring-red-500 focus:border-red-500" required>
                            <option value="all">Todo lo pendiente de este ID</option>
                            <option value="partial">Solo algunos materiales (selecciona abajo)</option>
                        </select>
                    </div>
                    
                    <h4 class="font-semibold mb-3 text-gray-700 border-b pb-2">Registro de compra por material</h4>

                    <div class="space-y-2 max-h-72 overflow-y-auto pr-2">
                        ${materialesHtml}
                    </div>

                    <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                            Confirmar Compra
                        </button>
                    </div>
                </form>
            `;
        };

        const handleComprasSubmit = (e, id) => {
            e.preventDefault();
            const form = e.target;
            const errorDiv = document.getElementById('compras-error');
            errorDiv.classList.add('hidden');
            
            const proveedor = form.proveedor.value.trim();
            if (!proveedor) {
                errorDiv.textContent = 'Debe registrar un proveedor.';
                errorDiv.classList.remove('hidden');
                return;
            }

            const purchaseMode = form.purchase_mode.value;

            const allReqs = loadData(DB_KEY);
            const reqIndex= allReqs.findIndex(r => r.id === id);
            if (reqIndex === -1) return;

            try {
                let anyPurchased = false;

                const updatedMaterials = allReqs[reqIndex].materiales.map((mat, index) => {
                    const stock      = mat.stock_available || 0;
                    const yaComprado = mat.comprado_qty   || 0;
                    const pendiente  = Math.max(mat.cantidad - stock - yaComprado, 0);

                    if (pendiente <= 0) {
                        return mat;
                    }

                    const checkbox    = form[`comprado_${index}`];
                    const seleccionado= purchaseMode === 'all' || (checkbox && checkbox.checked);

                    if (!seleccionado) {
                        return mat;
                    }

                    const unitCostField = form[`costo_unitario_${index}`];
                    if (!unitCostField || !unitCostField.value) {
                        throw new Error(`Debe capturar el costo unitario para el material "${mat.descripcion}" seleccionado.`);
                    }

                    const unitCost = parseFloat(unitCostField.value);
                    if (isNaN(unitCost) || unitCost <= 0) {
                        throw new Error(`El costo unitario para "${mat.descripcion}" debe ser un número positivo.`);
                    }

                    anyPurchased = true;

                    return {
                        ...mat,
                        costo_unitario: unitCost,
                        comprado_qty: (mat.comprado_qty || 0) + pendiente,
                    };
                });

                allReqs[reqIndex].materiales = updatedMaterials;
                allReqs[reqIndex].proveedor  = proveedor;

                const newTotalCost = updatedMaterials.reduce((sum, m) =>
                    sum + (m.costo_unitario || 0) * (m.comprado_qty || 0)
                , 0);
                allReqs[reqIndex].costo = newTotalCost;

                const pendientesRestantes = updatedMaterials.some(m =>
                    Math.max(m.cantidad - (m.stock_available || 0) - (m.comprado_qty || 0), 0) > 0
                );

                if (anyPurchased && pendientesRestantes) {
                    allReqs[reqIndex].estado = 'Comprado (Parcial)';
                } else if (anyPurchased && !pendientesRestantes) {
                    allReqs[reqIndex].estado = 'Comprado';
                }

                saveData(DB_KEY, allReqs);
                closeModal();
            } catch (err) {
                errorDiv.textContent = 'Error: ' + err.message;
                errorDiv.classList.remove('hidden');
            }
        };

        // --- COMENTARIOS / BITÁCORA ---

        const generateComentariosForm = (req) => {
            const comentarios = req.comentarios || [];
            const listHtml = comentarios.length
                ? comentarios.map(c => `
                    <div class="border-b pb-2 mb-2">
                        <p class="text-xs text-gray-500">
                            <span class="font-semibold">${c.usuario}</span> (${c.rol}) - ${c.fecha}
                        </p>
                        <p class="text-sm text-gray-800 mt-1">${c.texto}</p>
                    </div>
                  `).join('')
                : `<p class="text-xs text-gray-500 italic">Sin comentarios aún.</p>`;

            return `
                <div class="mb-4 max-h-64 overflow-y-auto border rounded-lg p-3 bg-gray-50">
                    ${listHtml}
                </div>
                <form id="comentarios-form" onsubmit="handleComentarioSubmit(event, ${req.id})">
                    <div id="comentarios-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg font-medium mb-4"></div>
                    <div class="mb-3">
                        <label class="text-sm font-medium text-gray-700 mb-1 block">Agregar comentario</label>
                        <textarea name="texto" rows="3" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500" required></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg">Cerrar</button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="send" class="w-4 h-4 mr-1"></i>Guardar comentario
                        </button>
                    </div>
                </form>
            `;
        };

        const handleComentarioSubmit = (e, id) => {
            e.preventDefault();
            const errorDiv = document.getElementById('comentarios-error');
            errorDiv.classList.add('hidden');
            const texto = e.target.texto.value.trim();
            if (!texto) {
                errorDiv.textContent = 'El comentario no puede estar vacío.';
                errorDiv.classList.remove('hidden');
                return;
            }

            const allReqs = loadData(DB_KEY);
            const index   = allReqs.findIndex(r => r.id === id);
            if (index === -1) return;

            const nowStr = new Date().toISOString().replace('T', ' ').split('.')[0];
            allReqs[index].comentarios = allReqs[index].comentarios || [];
            allReqs[index].comentarios.push({
                usuario: currentUserId,
                rol: currentRole,
                fecha: nowStr,
                texto
            });

            saveData(DB_KEY, allReqs);
            // Reabrimos el modal para ver el comentario recién agregado
            openModal('comentarios', id);
        };

        // --- FINALIZAR REQUISICIÓN (Mantenimiento cierra ciclo) ---

        const generateFinalizarForm = (req) => {
            const pendientes = (req.materiales || []).filter(m =>
                Math.max(m.cantidad - (m.stock_available || 0) - (m.comprado_qty || 0), 0) > 0
            );
            const tienePendientes = pendientes.length > 0;

            const alerta = tienePendientes
                ? `<p class="text-xs text-red-600 font-semibold mb-2">Advertencia: Aún hay materiales con cantidad pendiente según el sistema.</p>`
                : `<p class="text-xs text-green-700 font-semibold mb-2">Todos los materiales están cubiertos según el sistema.</p>`;

            return `
                <form id="finalizar-form" onsubmit="handleFinalizarSubmit(event, ${req.id})">
                    <div class="mb-4 text-sm text-gray-700 border p-4 rounded-lg bg-gray-50">
                        <p><span class="font-semibold">Proyecto:</span> ${req.proyecto}</p>
                        <p><span class="font-semibold">Fecha Mantenimiento:</span> ${req.fecha_mantenimiento}</p>
                        <p><span class="font-semibold">Estado actual:</span> ${req.estado}</p>
                        <p class="mt-2 text-xs text-gray-600">Al finalizar, la requisición se marcará como <strong>Finalizada</strong> y ya no podrá modificarse.</p>
                        <div class="mt-3">
                            ${alerta}
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="check-circle" class="w-4 h-4 mr-1"></i>Confirmar Finalización
                        </button>
                    </div>
                </form>
            `;
        };

        const handleFinalizarSubmit = (e, id) => {
            e.preventDefault();
            const allReqs = loadData(DB_KEY);
            const index   = allReqs.findIndex(r => r.id === id);
            if (index === -1) return;

            const req = allReqs[index];
            if (currentRole !== ROLES.MANTENIMIENTO || req.solicitante_id !== currentUserId) {
                alert('Solo el solicitante puede finalizar la requisición.');
                return;
            }

            if (req.estado !== 'Comprado' && req.estado !== 'Comprado (Parcial)') {
                alert('Solo se pueden finalizar requisiciones en estado "Comprado" o "Comprado (Parcial)".');
                return;
            }

            const nowStr = new Date().toISOString().replace('T', ' ').split('.')[0];
            req.estado             = 'Finalizada';
            req.fecha_finalizacion = nowStr;
            req.finalizado_por     = currentUserId;

            allReqs[index] = req;
            saveData(DB_KEY, allReqs);
            closeModal();
        };

        // --- INVENTARIO GLOBAL ---

        const openInventoryModal = () => {
            const modal = document.getElementById('inventory-modal');
            const tbody = document.getElementById('inventory-table-body');
            const inv   = loadData(INVENTORY_KEY);

            tbody.innerHTML = Object.keys(inv).map((desc, idx) => {
                const item = inv[desc];
                return `
                    <tr>
                        <td class="px-4 py-2 text-sm">
                            <input type="text" name="inv_desc_${idx}" value="${desc}" class="w-full p-1 border border-gray-300 rounded text-sm">
                        </td>
                        <td class="px-4 py-2 text-sm">
                            <input type="text" name="inv_unit_${idx}" value="${item.unidad || ''}" class="w-full p-1 border border-gray-300 rounded text-sm">
                        </td>
                        <td class="px-4 py-2 text-sm">
                            <input type="number" name="inv_stock_${idx}" value="${item.stock || 0}" min="0" class="w-full p-1 border border-gray-300 rounded text-sm">
                        </td>
                        <td class="px-4 py-2 text-sm">
                            <button type="button" onclick="deleteInventoryRow(this)" class="text-red-600 hover:text-red-800 text-xs">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');

            modal.classList.remove('hidden');
            lucide.createIcons();
        };

        const closeInventoryModal = () => {
            document.getElementById('inventory-modal').classList.add('hidden');
        };

        const addInventoryRow = () => {
            const tbody = document.getElementById('inventory-table-body');
            const idx   = tbody.querySelectorAll('tr').length;
            tbody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td class="px-4 py-2 text-sm">
                        <input type="text" name="inv_desc_${idx}" value="" class="w-full p-1 border border-gray-300 rounded text-sm" placeholder="Descripción">
                    </td>
                    <td class="px-4 py-2 text-sm">
                        <input type="text" name="inv_unit_${idx}" value="" class="w-full p-1 border border-gray-300 rounded text-sm" placeholder="Unidad">
                    </td>
                    <td class="px-4 py-2 text-sm">
                        <input type="number" name="inv_stock_${idx}" value="0" min="0" class="w-full p-1 border border-gray-300 rounded text-sm">
                    </td>
                    <td class="px-4 py-2 text-sm">
                        <button type="button" onclick="deleteInventoryRow(this)" class="text-red-600 hover:text-red-800 text-xs">Eliminar</button>
                    </td>
                </tr>
            `);
        };

        const deleteInventoryRow = (btn) => {
            const tr = btn.closest('tr');
            if (tr) tr.remove();
        };

        const saveInventory = () => {
            const tbody = document.getElementById('inventory-table-body');
            const rows  = tbody.querySelectorAll('tr');
            const errorDiv = document.getElementById('inventory-error');
            errorDiv.classList.add('hidden');

            const inv = {};
            rows.forEach((row, idx) => {
                const desc  = row.querySelector(`[name="inv_desc_${idx}"]`)?.value.trim() || '';
                const unit  = row.querySelector(`[name="inv_unit_${idx}"]`)?.value.trim() || '';
                const stock = parseInt(row.querySelector(`[name="inv_stock_${idx}"]`)?.value) || 0;
                if (!desc) return;
                inv[desc] = { unidad: unit || 'PZA', stock: stock >= 0 ? stock : 0 };
            });

            saveData(INVENTORY_KEY, inv);
            errorDiv.textContent = 'Inventario guardado correctamente.';
            errorDiv.classList.remove('hidden');
            errorDiv.classList.replace('bg-red-100', 'bg-emerald-100');
            errorDiv.classList.replace('text-red-700', 'text-emerald-700');
        };

        // --- EXPORTAR A CSV (para Excel) ---

        const sanitizeForCsv = (value, separator) => {
            if (value === null || value === undefined) return '';
            const str = String(value);
            if (str.includes('"') || str.includes(separator) || str.includes('\n') || str.includes('\r')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        };

        const exportToCsv = () => {
            const allReqs      = loadData(DB_KEY);
            const filteredReqs = filterRequisitions(allReqs);
            const dataToExport = (filteredReqs && filteredReqs.length > 0) ? filteredReqs : allReqs;
            
            if (!dataToExport || dataToExport.length === 0) {
                console.warn("No hay datos para exportar.");
                return;
            }

            const separator = ';';
            
            const headers = [
                "ID", "Fecha_Solicitud", "Fecha_Mantenimiento", "Proyecto_Tema",
                "Materiales_Detalle", "Utilizacion", "Proveedor", "Prioridad", 
                "Costo_Total", "Estado", "Solicitante_ID", "Revisado_Por", "Fecha_Revision",
                "Finalizado_Por", "Fecha_Finalizacion"
            ];

            let csvContent = headers.join(separator) + "\r\n";

            dataToExport.forEach(req => {
                const matDetail = (req.materiales || []).map(m => {
                    const pendiente = Math.max(m.cantidad - (m.stock_available || 0) - (m.comprado_qty || 0), 0);
                    let detail = `${m.cantidad} ${m.unidad} de ${m.descripcion}`;
                    detail += ` [Stock usado: ${m.stock_available || 0}, Comprado: ${m.comprado_qty || 0}, Pendiente: ${pendiente}]`;
                    if (m.costo_unitario > 0 && m.comprado_qty > 0) {
                        detail += ` (C/U: ${m.costo_unitario.toFixed(2)})`;
                    }
                    return detail;
                }).join(' | ');

                const row = [
                    req.id,
                    req.fecha_solicitud,
                    req.fecha_mantenimiento,
                    req.proyecto,
                    matDetail,
                    req.utilizacion || '',
                    req.proveedor || 'N/A',
                    req.prioridad,
                    calculateTotalCost(req).toFixed(2),
                    req.estado,
                    req.solicitante_id,
                    req.revisado_por || 'N/A',
                    req.fecha_revision || 'N/A',
                    req.finalizado_por || 'N/A',
                    req.fecha_finalizacion || 'N/A'
                ];

                csvContent += row.map(v => sanitizeForCsv(v, separator)).join(separator) + "\r\n";
            });

            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url  = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `requisiciones_${currentRole || 'todos'}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- INIT ---

        window.onload = () => {
            lucide.createIcons();
        };
    </script>
</body>
</html>